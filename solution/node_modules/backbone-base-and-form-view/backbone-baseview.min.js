//     Backbone.BaseView 0.8.3
//     (c) 2014 James Ballantine, 1stdibs.com Inc.
//     Backbone.BaseView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a){"use strict";var b=a.Backbone,c=a._;"undefined"!=typeof module&&(c=require("underscore"),a=a||{},a.Backbone=b=require("backbone"),module.exports=b);var d,e=function(b){for(var c=b.split("."),d=a[c.shift()];c.length&&d;)d=d[c.shift()];return d},f=Array.prototype.slice,g=c.result,h=c.each,i=c.isFunction,j=c.isObject,k=c.isArray,l=b.View,m=function(a,b,c){this.config={},this.clear(!0),this.parent=b,this.options=c||{},this.autoInitSingletons=!!this.options.autoInitSingletons,this.defaultToSingletons=this.options.defaultToSingletons,this.dotNotation=void 0!==this.options.dotNotation?this.options.dotNotation:!0,a&&this.addConfig(a)};m.prototype={add:function(a,b,c){var d,e,f,g=k(a)?a:k(b)?b:void 0,h=!g&&j(a)&&a instanceof l==!1?a:void 0,i=g||b instanceof l!=!1?void 0:b;if(h){c="boolean"==typeof b?b:void 0;for(d in h)if(h.hasOwnProperty(d))if(h[d]=k(h[d])?h[d]:[h[d]],f=h[d].length,f&&h[d][0]instanceof l)this._addInstance(d,h[d],c);else for(e=-1;++e<f;)this._init(d,h[d][e],c);return this}if(b=a instanceof l?a:b,a="string"==typeof a||"number"==typeof a?a:void 0,c="boolean"==typeof c?c:a||"boolean"!=typeof b?void 0:b,i)return this._init(a,i,c),this;if(g&&(f=g.length)){if(g[0]instanceof l)this._addInstance(a,g,c);else for(e=-1;++e<f;)this._init(a,g[e],c);return this}return b?this._addInstance(a,b,c):a&&this._init(a,c),this},addInstance:function(a,b){return a instanceof l&&(b=a,a=void 0),this._addInstance(a,b),this},addInstances:function(a,b){k(a)&&(b=a,a=void 0);for(var c=-1,d=b.length;++c<d;)this._addInstance(a,b[c]);return this},addInstancesWithMap:function(a){var b;for(b in a)a.hasOwnProperty(b)&&this.addInstance(b,a[b]);return this},create:function(a,b){return this._init(a,b)},createFromKeys:function(a,b){for(var c=[],d=a.length,e=-1;++e<d;)c.push(this._init(a[e],b));return c},createSingletons:function(a){var b;for(b in this.config)this.config.hasOwnProperty(b)&&this.config[b].singleton&&this._init(b,a);return this},createWithMap:function(a){var b;for(b in a)a.hasOwnProperty(b)&&this._init(b,a[b]);return this},setSingleton:function(a,b){return this._addInstance(a,b,!0),this},overrideSingleton:function(a,b){return this.remove(a),this.setSingleton(a,b)},addConfig:function(a,b){var c=j(a)&&!k(a)?a:!1;return c?(h(c,this._addConfig,this),this):this._addConfig(b,a)},render:function(a){a=a||{};var b=a.appendTo||a.useLocation;return this._render(this.subViews,b,a.clearLocations)},renderAppend:function(a,d){return d=d||{},j(a)&&a instanceof b.$==!1&&!c.isElement(a)&&(d=a,a=d.appendTo),this._render(this.subViews,a||!0,d.clearLocations)},renderByKey:function(a,b){var c=this.getByType(a)||this.get(a);return k(c)||(c=[c]),b=b||{},this._render(c,b.appendTo||b.useLocation,b.clearLocations)},filteredSubs:function(a){var b,c,d=-1,e=new m(null,this.parent,this.options);for(e.config=this.config,c=k(a)?a:i(a)?this.filter(a):this.getByType(a),b=c.length;++d<b;)e.add(c[d]._subviewtype,c[d]);return e},descend:function(a,b){var c=i(a),d=function(e){for(var f,g,h=-1,i=e.length;++h<i;)f=e[h],g=c?a:f[a],g&&(b?g.apply(f,b):g.call(e[h])),f.subViews&&f.subViews.length&&d(f.subViews)};return d(this.subViews),this},clear:function(a,b){return a||this.removeElems(),this.subViews=[],this.parent&&this.parent.subViews&&(this.parent.subViews=this.subViews),this._subViewsByType={},this._subViewSingletons={},this._subViewsByCid={},this._subViewsByModelCid={},b&&(this.config={}),this},remove:function(a,b){var c,d=a&&("string"==typeof a||a.cid)?this.get(a):a;if(!d)return this;for(k(d)||(d=[d]),c=d?d.length:0,b||this.removeElems(d),c&&this.trigger("remove",d);d&&d.length;)this._remove(d.shift());return this},removeByKeys:function(a,b){var c=0,d=a?a.length:0;for(c;d>c;c++)this.remove(a[c],b);return this},removeElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].remove();return this},detachElems:function(a){a=a||this.subViews;for(var b=-1,c=a.length;++b<c;)a[b].$el.detach();return this},get:function(a){if(a.cid)return this._subViewsByCid[a.cid]||this._subViewsByModelCid[a.cid];if(a.indexOf(".")>-1&&this.dotNotation){for(var b=a.split("."),c=this.parent;b.length&&c;)c=c.subs.get(b.shift());return c}return this._subViewSingletons[a]||this._subViewsByCid[a]||this._subViewsByModelCid[a]||this._subViewsByType[a]},getByType:function(a){return this._subViewsByType[a]?this._subViewsByType[a]:this._subViewSingletons[a]?[this._subViewSingletons[a]]:[]},getSubViewType:function(a){return a=a instanceof l==!0?a:this.get(a),a._subviewtype},at:function(a){return this.subViews[a]},clearLocations:function(a){var b=a?c.pick(this.config,a):this.config;return h(b,function(a){this.parent.$(a.location).html("")},this),this},setLocationForType:function(a,b){return this._addConfig({location:b},a),this},useDefaultLocationSelectors:function(a){var b;a=c.isString(a)?a:"-container";for(b in this.config)this.config.hasOwnProperty(b)&&!this.config[b].location&&this.setLocationForType(b,"."+b+a);return this},_render:function(a,c,d){var e,f,g=-1,h={};for(c!==!0&&(e=c),d&&this.clearLocations();++g<a.length;)if(a[g].render(),e)a[g].$el.appendTo("string"==typeof e?this.parent.$(e).first():e);else if(c&&(f=this.config[this.getSubViewType(a[g])].location)){if("string"==typeof f)h[f]||(h[f]=this.parent.$(f).first()),f=h[f];else if("function"==typeof f&&(f=f.call(a[g]),!(f instanceof b.$)))throw new Error("location function must return instance of jQuery");f.append(a[g].$el)}return this},_addInstance:function(a,b,d){var e,f=-1,g=this;if(a=a||"_svid_"+c.size(this.config),g._subViewSingletons[a])return g;for(k(b)||(b=[b]),e=b.length,g.config[a]||(g.config[a]={singleton:d}),!g.config[a].construct&&b[0].constructor&&(g.config[a].construct=b[0].constructor),d=void 0===d?g.config[a].singleton:d;++f<e;)g._setInst(a,b[f],d);return g},_addConfig:function(a,b){return a&&b?(this.config[b]=c.extend(this.config[b]||{},a),"boolean"!=typeof this.config[b].singleton&&(this.config[b].singleton=this.defaultToSingletons),this.autoInitSingletons&&this.config[b].singleton?this._init(b):this):this},_remove:function(a,b){for(var c=-1,d=this.subViews.length,e=this.getSubViewType(a),f=this.getByType(e);++c<d;)if(this.subViews[c].cid===a.cid){this.subViews.splice(c,1);break}if(d=f?f.length:0,!this._subViewSingletons[e]&&d)for(c=0;d>c;c++)if(f[c].cid===a.cid){f.splice(c,1);break}delete this._subViewsByCid[a.cid],a.model&&a.model.cid&&this._subViewsByModelCid[a.model.cid]&&delete this._subViewsByModelCid[a.model.cid],this._subViewSingletons[e]&&delete this._subViewSingletons[e],b||this.trigger("remove:"+e,a)},_setInst:function(a,b,c,d){var e=b.model?b.model.cid:null,f=this._subViewsByModelCid;return this.subViews.push(b),this._subViewsByCid[b.cid]=b,b.parentView||(b.parentView=this.parent),b._subviewtype=a,e&&(f[e]?(k(f[e])||(f[e]=[f[e]]),f[e].push(b)):this._subViewsByModelCid[e]=b),c="boolean"==typeof c?c:this.defaultToSingletons,c?this._subViewSingletons[a]=b:(this._subViewsByType[a]||(this._subViewsByType[a]=[]),this._subViewsByType[a].push(b)),this.newest=b,d?this:this.trigger("add",b).trigger("add:"+a,b)},_init:function(a,b,d){var f,g=this.config[a],h=g&&g.construct?g.construct:null;return this._subViewSingletons[a]?void 0:(b=c.extend({},g.options||{},b||{}),(h="string"==typeof h?e(h):h)?(f=new h(b,this.parent),this._setInst(a,f,void 0!==d?d:g.singleton),f):(console.error('Construct for key "'+a+'" was not found:',g?g.construct:""),void 0))}},h(["each","map","initial","rest","last","first","find","filter","sortBy","groupBy","where","findWhere","some","every","invoke","contains","max","min","size","without","indexOf","lastIndexOf","isEmpty","reject"],function(a){m.prototype[a]=function(){return c[a].apply(this,[this.subViews].concat(f.call(arguments)))}}),c.extend(m.prototype,b.Events),d=l.extend({subViews:null,subs:null,subViewConfig:null,autoInitSubViews:!1,singletonSubViews:!1,parentView:null,constructor:function(a,b){var c=a&&a.subViewConfig?a.subViewConfig:this.subViewConfig;c=i(c)?c.call(this):c,this.parentView=b instanceof l?b:null,this.subs=new m(null,this,{autoInitSingletons:this.autoInitSubViews,defaultToSingletons:this.singletonSubViews}),c&&this.subs.addConfig(c),this.subViews=this.subs.subViews,this._stopPropogation={},d.__super__.constructor.call(this,a),this.viewEvents=a&&a.viewEvents?a.viewEvents:this.viewEvents,this.viewEvents&&this.bindViewEvents()},render:function(){var a="",b=this.template;return i(b)&&(a=b(g(this,"templateVars"))||""),this.$el.html(a),this.subs.renderAppend(),this},place:function(a,c){if("string"==typeof a){var d=this.parentView?this.parentView.$el:b.$("body");a=d.find(a)}return c?(a.html(this.el),this):(a.append(this.el),this)},remove:function(){return d.__super__.remove.call(this),this.subs.removeElems(),this},stopEvent:function(a){return console.assert(!!a,"event parameter is required"),this._stopPropogation[a]=!0,this},triggerBubble:function(a){var b,c,d=f.call(arguments,1);for(d.unshift(a),d.push(this),c=this;c;){if(c.trigger.apply(c,d),b=c._stopPropogation,b&&b[a])return b[a]=!1,this;c=c.parentView}return this},triggerDescend:function(a){var b=f.call(arguments,1),c=function(d){for(var e,f,g,h=-1,i=d.length;++h<i;)g=!0,d[h].trigger.apply(d[h],b),f=d[h]._stopPropogation,f&&f[a]&&(f[a]=!1,g=!1),e=d[h].subViews,g&&e&&e.length&&c(e)};return b.unshift(a),b.push(this),c([this]),this},ascend:function(a,b){for(var c,d=this,e=i(a);d.parentView;)d=d.parentView,d&&(c=e?a:d[a],c.apply(d,b));return this},findAncestor:function(a){for(var b=this;b.parentView;)if(b=b.parentView,b&&a(b))return b;return null},findAncestorByConstruct:function(a){return this.findAncestor(function(b){return b instanceof a})},findAncestorByType:function(a){return this.findAncestor(function(b){return a&&b._subviewtype===a})},getSubViewType:function(){return this._subviewtype},getTopView:function(){for(var a=this;a.parentView;)a=a.parentView;return a},isTopView:function(){return!this.parentView},bindViewEvents:function(a){return a=a||g(this,"viewEvents"),h(a,function(a,b){var c=b.split(" "),d=c.length>1?this[c[1]]:this;a=i(a)?a:this[a],d&&(this.stopListening(d,c[0],a),this.listenTo(d,c[0],a))},this),this}}),b.BaseView=d}(this);