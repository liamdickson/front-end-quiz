//     Backbone.FormView 0.8.3
//     (c) 2014 James Ballantine, 1stdibs.com Inc.
//     Backbone.FormView may be freely distributed under the MIT license.
//     For all details and documentation:
//     https://github.com/1stdibs/backbone-base-and-form-view
!function(a){"use strict";var b=a.Backbone,c=a._;if("undefined"!=typeof module&&(c=require("underscore"),b=require("./backbone-baseview"),module.exports=b),!b||!b.BaseView)throw new Error("Backbone and Backbone.BaseView required");var d,e,f,g,h,i,j,k,l=b.Model,m=b.Collection,n=c.each,o=c.extend,p=c.defaults,q=c.clone,r=c.isUndefined,s=c.isFunction,t=c.isArray,u=c.isString,v=c.result,w=String,x={disable:function(){return this.subs.each(function(a){s(a.disable)&&a.disable()}),this},enable:function(){return this.subs.each(function(a){s(a.enable)&&a.enable()}),this}},y=function(){var a=this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix():"";return a+this.fieldSetName+"-"},z=function(){return o({},this._defaultTemplateVars,v(this,"templateVars"))},A=function(a,b,c){return a instanceof c?a:a===!0&&b instanceof c?b:b?(b=b.get(a),b instanceof c?b:null):null},B=function(a,b,c){return a?A(a,c,l)||c:A(b,c,l)||c},C=function(a,b,c,d){return a?A(a,c,m)||d:A(b,c,m)||null};b.FormView=b.BaseView.extend({tagName:"form",className:"form-horizontal",fieldAlias:{Text:"Backbone.fields.FieldView",RadioList:"Backbone.fields.RadioListView",CheckList:"Backbone.fields.CheckListView",Select:"Backbone.fields.SelectListView",FieldSet:"Backbone.FieldSetView",Checkbox:"Backbone.fields.CheckBoxView",CollectionField:"Backbone.CollectionFieldSetView"},template:c.template('<div data-fields=""></div>'),fieldsWrapper:"[data-fields]:first",initialize:function(a){a=this.options=p(a||{},this.options);var b=a.schema||this.schema,d=r(a.setupOnInit)?this.setupOnInit:a.setupOnInit;o(this,{templateVars:a.templateVars||this.templateVars||{},setupOnInit:a.setupOnInit||this.setupOnInit,validateOnSet:r(a.validateOnSet)?this.validateOnSet:a.validateOnSet,twoWay:r(a.twoWay)?this.twoWay:a.twoWay,autoUpdateModel:r(a.autoUpdateModel)?this.autoUpdateModel:a.autoUpdateModel,fieldsWrapper:a.fieldsWrapper||this.fieldsWrapper}),this._defaultTemplateVars=this._defaultTemplateVars||{label:a.label},this.template=a.template||(u(this.template)?c.template(this.template):this.template),this.subViewConfig=a.subViewConfig||null,b&&(this.setSchema(b),d&&this.setupFields())},setSchema:function(a){return this.schema=a||this.schema,this},setSubViewConfig:function(a){return this.subViewConfig=a,this.subs.addConfig(a),this},hasSetupFields:function(){return this._hasSetupFields},setupFields:function(){var a=this._setupSubViewConfig(v(this,"schema"));return this.setSubViewConfig(a),this.subs.createSingletons(),this._setHasSetupFields(!0),this},setModelAttrs:function(){return this.subs.each(function(a){s(a.setModelAttrs)&&a.setModelAttrs()}),this},getFieldsWrapper:function(){var a=this.$(this.fieldsWrapper);return a.length?a.first():this.$el},render:function(){var a=this.options.fieldOrder||this.fieldOrder;if(this.subs.detachElems(),this.hasSetupFields()||this.setupFields(),this.$el.html(this.template(this._getTemplateVars())),a&&a.length)for(a=a.slice(0);a.length;)this.subs.renderByKey(a.shift(),{useLocation:!0});else this.subs.renderAppend();return this},_setHasSetupFields:function(a){return this._hasSetupFields=a,this},_setupSubViewConfig:function(a,b,c){var d,e,f,g=this,h={};return b=b||this.model,c=c||this.collection,n(a,function(a,i){f=h[i]=q(a),f.options=s(a.options)?a.options.call(this):q(a.options||{}),d=f.options=f.options||{},f.singleton=void 0===f.singleton?!0:f.singleton,f.construct=g.fieldAlias[f.type||f.construct]||f.type||f.construct,f.location=f.location||g.fieldsWrapper,d.model=B(d.model,i,b),this.validateOnSet&&(d.setOpts=p(d.setOpts||{},{validate:!0})),this.twoWay&&(d.twoWay=r(d.twoWay)?this.twoWay:d.twoWay),e=C(d.collection,i,b,c),e&&(d.collection=e),d.schema&&(d.subViewConfig=g._setupSubViewConfig(d.schema,d.model)),d.schemaKey=i},this),h},_getTemplateVars:z},{addFieldAlias:function(a,c){var d={},e=b.FormView.prototype.fieldAlias;c?d[a]=c:d=a,p(e,d)}}),o(b.FormView.prototype,x),j=b.CollectionFormRowView=b.FormView.extend({className:"form-field-row controls-row",tagName:"div",getFieldPrefix:function(){var a="",b=this.rowIndex();return this.parentView&&this.parentView.getFieldPrefix&&(a=this.parentView.getFieldPrefix(this)||""),a+(c.isNumber(b)&&b>-1?b+"-":"")},deleteSelf:function(){return this.parentView.deleteRow(this),this},rowIndex:function(){if(this.parentView&&this.parentView.subs){var a=this.parentView.subs.get("row");if(a)return a.indexOf(this)}return null}}),b.CollectionFormView=b.BaseView.extend({tagName:"form",className:"form",rowWrapper:"[data-rows]:first",template:c.template('<div data-rows=""></div>'),initialize:function(a){var d,e=this;a=e.options=p(a||{},e.options),e.template=a.template||(u(e.template)?c.template(e.template):e.template),e.setupOnInit=r(a.setupOnInit)?e.setupOnInit:a.setupOnInit,e.rowOptions=a.rowOptions||e.rowOptions,e.templateVars=a.templateVars||e.templateVars||{},e._defaultTemplateVars={label:a.label},e.rowWrapper=a.rowWrapper||e.rowWrapper,a.rowConfig?(e.rowConfig=a.rowConfig,e.rowConfig=q(v(e,"rowConfig"))||{},e.rowConfig.options=e.rowConfig.options?q(e.rowConfig.options):{}):(e.rowConfig=q(v(e,"rowConfig"))||{singleton:!1,construct:b.CollectionFormRowView},d=q(v(e,"rowOptions")),e.rowConfig.options=d||e.rowConfig.options||{},e.setRowSchema(a.rowSchema||e.rowSchema||e.rowConfig.options.schema)),e.rowConfig.location=e.rowWrapper,e.subs.addConfig("row",e.rowConfig),e.setupOnInit&&e.setupRows()},setRowSchema:function(a){return this.rowConfig.options||(this.rowConfig.options={}),this.rowConfig.options.schema=a||this.options.rowSchema||this.rowSchema,this},render:function(){return this.subs.detachElems(),this.$el.html(this.template(this._getTemplateVars())),this.getRows()&&this.getRows().length||this.setupRows(),this.subs.renderByKey("row",{appendTo:this.getRowWrapper()}),this},getRowWrapper:function(){var a=this.$(this.subs.config.row.location);return a.length?a.first():this.$el},addRow:function(a){var c;return a=a||new this.collection.model,c=this.collection.add(a),c instanceof b.Collection||(a=c),this._addRow(a).subs.newest.render().$el.appendTo(this.getRowWrapper()),this},deleteRow:function(a){var c=a instanceof l?a:null,d=!c&&a instanceof b.View?a:null,e=c||d||!t(a)?null:a;return e?(n(e,this.deleteRow,this),this):(d?c||(c=d.model):d=this.subs.get(c),this.subs.remove(d),this.collection.remove(c),this)},reset:function(){return this.setupRows().subs.renderByKey("row",{appendTo:this.getRowWrapper()}),this},getRows:function(){return this.subs.get("row")},setupRows:function(){return this.subs.remove("row"),this.collection.each(this._addRow,this),this},_addRow:function(a){var b=this._getRowOptions(a),c=this.subs.create("row",b);return c.setSchema(this.rowSchema).setupFields(),this},_getRowOptions:function(a){var b=this.subs.get("row")||[];return{model:a,index:b.length}},_getTemplateVars:z}),o(b.CollectionFormView.prototype,x),b.formTemplates=b.formTemplates||{},b.formTemplates.Field='<% if (obj.label) { %><label class="control-label" <% if (obj.inputId) { %> for="<%= obj.inputId %>" <% } %> ><%= obj.label %></label><% } %><div class="<%= obj.inputWrapperClass || \'controls\' %>" data-input=""></div><div class="controls"><div class="<%= obj.errorClass || \'text-error\' %>" data-error=""></div><% if (obj.help) { %><span class="help-block"><%= obj.help %></span><% } %></div>',b.fields=b.fields||{},d=b.fields.FieldView=b.BaseView.extend({tagName:"div",classDefaults:"control-group form-field",inputPrefix:"field-input-",fieldPrefix:"form-field-",template:c.template(b.formTemplates.Field),addId:!0,elementType:"input",inputWrapper:"[data-input]:first",disabledDataKey:"formViewDisabled",events:function(){var a={};return a["blur "+this.elementType]="onUserUpdate",a},initialize:function(a){a=this.options=p(a||{},this.options),o(this,{templateVars:a.templateVars||this.templateVars||{},fieldName:a.fieldName||this.fieldName||a.schemaKey,elementType:a.elementType||this.elementType,template:a.template||this.template,setOpts:p(a.setOpts||{},this.setOpts),twoWay:r(a.twoWay)?this.twoWay:a.twoWay,inputAttrs:a.inputAttrs||this.inputAttrs,placeholder:a.placeholder||this.placeholder,inputClass:a.inputClass||this.inputClass,addId:r(a.addId)?this.addId:a.addId,label:r(a.label)?this.label:a.label,inputWrapper:a.inputWrapper||this.inputWrapper,inputId:a.inputId||this.inputId}),this.inputId=this.addId?this._getInputId():!1,this.template=u(this.template)?c.template(this.template):this.template,this._defaultTemplateVars=this._defaultTemplateVars||{inputId:this.inputId,help:a.help,fieldName:this.fieldName,label:this.label},r(this.className)&&(this.$el.addClass(this.fieldPrefix+this.fieldName),this.$el.addClass(this.classDefaults)),this.$el.attr("data-field",""),this.twoWay&&this.setupTwoWay&&this.setupTwoWay()},setupTwoWay:function(){return this.listenTo(this.model,"change:"+this.fieldName,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1}),this},getAttrs:function(){var a={};return a[this.fieldName]=this.getValueForSet(),a},setModelAttrs:function(){return this._viewChangedModel=!0,this.model.set(this.getAttrs(),this.setOpts)||(this._viewChangedModel=!1),this},getValue:function(){return b.$.trim(this.getInputEl().val())},getValueForSet:function(){return this.getValue()},getModelVal:function(){return this.model.get(this.fieldName)},getValueForInput:function(){return this.getModelVal()},render:function(){return this.renderWrapper().renderInput()},renderWrapper:function(a){return this.isDisabled=null,this.$el.html(this.template(a||this._getTemplateVars())),this},renderInput:function(){var a,c=this.inputId,d=this.addId?{id:c,name:c}:{},e=this.getValueForInput();return a=b.$("<"+this.elementType+">"),"input"===this.elementType&&(d.type="text"),this.placeholder&&(d.placeholder=this.placeholder),a.attr(o(d,this.inputAttrs)),this.inputClass&&a.attr("class",this.inputClass),this.getInputWrapper().html(a),this._shouldSetValueOnInput(e)&&a.val(e),this.isDisabled=null,this},getInputWrapper:function(){var a=this.$(this.inputWrapper);return a.length?a.first():this.$el},getInputEl:function(){return this.$(this.elementType)},disable:function(){return this.getInputEl().prop("disabled",!0),this.isDisabled=!0,this},enable:function(){return this.getInputEl().prop("disabled",!1),this.isDisabled=!1,this},onUserUpdate:function(){this.setModelAttrs()},_getInputId:function(){return this.inputId||this.inputPrefix+this._getParentPrefix()+this.fieldName},_getTemplateVars:z,_getParentPrefix:function(){return this.parentView&&this.parentView.getFieldPrefix?this.parentView.getFieldPrefix(this)||"":""},_shouldSetValueOnInput:function(a){return!!a||0===a}},{setDefaultFieldTemplate:function(a){d.prototype.template=a}}),e=b.fields.RadioListView=b.fields.FieldView.extend({tagName:"div",events:function(){var a={};return a["click "+this.elementType]="onUserUpdate",a},type:"radio-list",initialize:function(a){a=this.options=p(a||{},this.options),this.possibleVals=a.possibleVals||this.possibleVals||{},this.labelAttrs=a.labelAttrs||this.labelAttrs,e.__super__.initialize.call(this,a)},getValue:function(){return this.$(this.elementType+":checked").val()},isSelected:function(a){return w(this.getValueForInput())===w(a)},renderInput:function(){var a,b,c,d,e=v(this,"possibleVals"),f=0,g=this.getInputWrapper().empty();for(a in e)e.hasOwnProperty(a)&&(b=this._parsePossibleVal(e,a),d=this.isSelected(b.value),c=this._renderInput(b,d,f),g.append(c),f++);return this},_renderInput:function(a,c,d){var e,f,g=this.inputId,h={type:"radio"},i=p(this.labelAttrs||{},{"class":"radio"});return this.addId&&o(h,{name:g,id:g+"-"+d}),c&&(h.checked="checked"),o(h,this.inputAttrs,{value:a.value}),this.inputClass&&(h["class"]=this.inputClass),e=b.$("<"+this.elementType+">").attr(h),f=b.$("<label>").attr(i),f.append(e).append(a.display),f},_parsePossibleVal:function(a,b){var c=a[b];return c&&!r(c.value)&&c.display?c:a.slice&&t(a)?{value:c,display:c}:(b&&!isNaN(Number(b))&&(b=Number(b)),{value:b,display:c})}}),f=b.fields.SelectListView=b.fields.RadioListView.extend({type:"select-list",elementType:"select",events:function(){var a={};return a["change "+this.elementType]="onUserUpdate",a},initialize:function(a){a=this.options=p(a||{},this.options),this.multiple=r(a.multiple)?this.multiple:a.multiple,f.__super__.initialize.call(this,a)},getValue:function(){return this.getInputEl().val()},isSelected:function(a){var b=this.getModelVal();return b=this.multiple?b:[b],c.indexOf(c.map(b,w),w(a))>-1},renderInput:function(){var a=v(this,"possibleVals"),c=this.inputId,d=b.$("<"+this.elementType+">").attr(o(this.addId?{id:c,name:c}:{},this.inputAttrs));return this.getInputWrapper().html(d),this.multiple&&d.attr("multiple","multiple"),this.inputClass&&d.addClass(this.inputClass),this.placeholder&&d.append('<option value="">'+this.placeholder+"</option>"),this._renderInput(d,a)},_renderInput:function(a,c){var d,e,f,g;for(d in c)c.hasOwnProperty(d)&&(e=this._parsePossibleVal(c,d),e.group?(f=b.$('<optgroup label="'+d+'"></optgroup>').appendTo(a),this._renderInput(f,e.group)):(g=b.$("<option>").text(e.display).attr("value",e.value),this.isSelected(e.value)&&g.prop("selected",!0),g.appendTo(a)));return this},_parsePossibleVal:function(a,b){var d=a[b];return d&&d.group&&d.display?d:c.isObject(d)&&!t(a)?{group:d,display:b}:f.__super__._parsePossibleVal.call(this,a,b)}}),g=b.fields.CheckListView=b.fields.RadioListView.extend({tagName:"div",type:"check-list",checkedVal:!0,unCheckedVal:!1,initialize:function(a){a=this.options=p(a||{},this.options),this.checkedVal=r(a.checkedVal)?this.checkedVal:a.checkedVal,this.unCheckedVal=r(a.unCheckedVal)?this.unCheckedVal:a.unCheckedVal,g.__super__.initialize.call(this,a)},setupTwoWay:function(){var a=v(this,"possibleVals");n(a,function(b,c){var d=this._parsePossibleVal(a,c);this.listenTo(this.model,"change:"+d.value,function(){this._viewChangedModel||this.renderInput(),this._viewChangedModel=!1})},this)},getAttrs:function(){var a={},c=this;return this.getInputEl().each(function(d,e){var f=b.$(e),g=f.val(),h=f.prop("checked")?c.checkedVal:c.unCheckedVal;(h===c.checkedVal||c.isSelected(g))&&(a[g]=h)}),a},getModelVal:function(a){return this.model.get(a)},renderSingleCheckbox:function(a,c,d){var e,f,g=this.inputId,h={type:"checkbox",value:a.value};return this.addId&&o(h,{name:g,id:g+"-"+d}),h=o(h,this.inputAttrs),this.inputClass&&(h["class"]=this.inputClass),c&&(h.checked="checked"),e=b.$("<input>").attr(h),f=b.$("<label>").attr(p(this.labelAttrs||{},{"class":"checkbox"})),f.append(e).append(a.display)},isSelected:function(a){return this.getModelVal(a)===this.checkedVal},renderInput:function(){var a,b,c,d,e=v(this,"possibleVals"),f=0,g=this.getInputWrapper().empty();for(a in e)e.hasOwnProperty(a)&&(b=this._parsePossibleVal(e,a),d=this.isSelected(b.value),c=this.renderSingleCheckbox(b,d,f),g.append(c),f++);return this}}),h=b.fields.CheckBoxView=b.fields.FieldView.extend({checkedVal:!0,unCheckedVal:!1,events:function(){var a={};return a["click "+this.elementType]="onUserUpdate",a},initialize:function(a){a=this.options=p(a||{},this.options),this.checkedVal=r(a.checkedVal)?this.checkedVal:a.checkedVal,this.unCheckedVal=r(a.unCheckedVal)?this.unCheckedVal:a.unCheckedVal,this.displayText=a.displayText||this.displayText,this.labelAttrs=a.labelAttrs||this.labelAttrs,h.__super__.initialize.call(this,a)},getValue:function(){return this.getInputEl().prop("checked")},getValueForSet:function(){return this.getValue()?this.checkedVal:this.unCheckedVal},isSelected:function(){return this.getModelVal()===this.checkedVal},renderInput:function(){var a=b.$("<label>").attr(p(this.labelAttrs||{},{"class":"checkbox"})),c=b.$("<"+this.elementType+">"),d={type:"checkbox"},e=this.inputId;return this.addId&&o(d,{id:e,name:e,value:this.checkedVal}),o(d,this.inputAttrs),this.inputClass&&(d["class"]=this.inputClass),c.attr(d),this.isSelected()&&c.prop("checked",!0),a.append(c),this.displayText&&a.append(this.displayText),this.getInputWrapper().html(a),this}}),i=b.FieldSetView=b.FormView.extend({tagName:"div",setupOnInit:!0,className:"",initialize:function(a){a=this.options=p(a||{},this.options),this.fieldSetName=a.fieldSetName||this.fieldSetName||a.schemaKey,i.__super__.initialize.call(this,a),this.$el.addClass(this.className||"fieldset fieldset-"+this.fieldSetName)},getFieldPrefix:y,template:c.template('<% if(obj && obj.label) { %><label class="fieldset-label"><strong><%= obj.label %></strong></label><% } %><fieldset data-fields=""></fieldset>')}),k=b.CollectionFieldSetView=b.CollectionFormView.extend({tagName:"div",template:c.template('<% if(obj && obj.label) { %><p><strong><%= obj.label %></strong></p><% } %><fieldset class="fieldset" data-rows=""></fieldset>'),setupOnInit:!0,className:"",initialize:function(a){return a=this.options=p(a||{},this.options),this.fieldSetName=a.fieldSetName||this.fieldSetName||a.schemaKey,k.__super__.initialize.call(this,a),this.$el.addClass(this.className||"fieldset fieldset-"+this.fieldSetName),this},getFieldPrefix:y})}(this);