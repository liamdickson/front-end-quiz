<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/style.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>

<div class="container">
    <div id="form"></div>
</div>

<script type="text/template" id="parent-template">
    <form>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group" id="title">
                </div>
                <div class="form-group" id="description">
                </div>
                <div class="form-group" id="notes">
                </div>
                <div class="form-group" id="materials">
                </div>
            </div>
        </div>
        <div class="row top-buffer-lg" id="measurements">
        </div>
        <div class="row top-buffer-lg" id="condition">
        </div>
        <div class="row top-buffer-lg" id="button">
        </div>
    </form>
</script>

<script type="text/template" id="title-template">
    <input id="id" hidden="" value="<%= id ? id : '' %>">
    <label for="inputTitle">Title</label>
    <input name="title" type="text" id="inputTitle" class="form-control" required="" value="<%= title ? title : '' %>">
</script>

<script type="text/template" id="description-template">
    <label for="inputDescription">Description</label>
    <textarea name="description" id="inputDescription" class="form-control" required="" rows="10"
            ><%= description ? description : '' %></textarea>
</script>

<script type="text/template" id="notes-template">
    <label for="inputNotes">internal notes</label>
    <textarea name="dealerInternalNotes" id="inputNotes" class="form-control" required=""
            ><%= dealerInternalNotes ? dealerInternalNotes : '' %></textarea>
</script>

<script type="text/template" id="materials-template">
    <label for="selectMaterials">Materials</label>
    <select name="material-description" id="selectMaterials" class="form-control" required="">
        <option disabled="">Select...</option>
        <% _.each(itemEnums.material, function(mat){ %>
        <option <%= item.material.description === mat ? 'selected=""' : '' %> ><%= mat %></option>
        <% }); %>
    </select>
    <div class="checkbox">
        <label><input name="material-restricted" id="restrictedMaterial" type="checkbox"
            <%= (item.material.restricted === "Y") ? 'checked=""' : '' %> >
            <b>Check this box</b> if the listing contains or may contain restricted materials
        </label>
    </div>
</script>

<script type="text/template" id="measurements-template">
    <div class="form-group">
        <div class="col-md-12">
            <label>Measurements</label>
            <div class="radio" id="measurement-unit">
                Measurements are in:
                <% _.each(itemEnums.measurement.unit, function(unit, abbr){ %>
                <label class="radio-inline measurement-unit"><input id="<%= abbr %>" type="radio"
                                                                    value="<%= abbr %>" name="measurement-unit"
                    <%=item.measurement.unit === abbr ? 'checked' : '' %> >
                    <%= unit.charAt(0).toUpperCase() + unit.slice(1)  %> (<%= abbr %>)
                </label>
                <% }); %>
            </div>
            <div class="radio" id="measurement-shape">
                Measured item is:
                <% _.each(itemEnums.measurement.shape, function(shape){ %>
                <label class="radio-inline measurement-unit"><input id="<%= shape %>" type="radio"
                                                                    value="<%= shape %>" name="measurement-shape"
                    <%=item.measurement.shape === shape ? 'checked' : '' %> >
                    <%= shape  %>
                </label>
                <% }); %>
            </div>
            <div class="row top-buffer-md">
                <div class="col-md-3">
                    <label for="inputLength">Length:</label>
                    <div class="input-group">
                        <input type="text" name="measurement-length" class="form-control measurement-input"
                               aria-describedby="length-addon" id="inputLength"
                        <%= item.measurement.length ? 'value='+item.measurement.length : '' %> >
                        <span class="input-group-addon" id="length-addon">in.</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="inputDepth">Depth:</label>
                    <div class="input-group">
                        <input type="text" name="measurement-depth" class="form-control measurement-input"
                               aria-describedby="depth-addon" id="inputDepth"
                        <%= item.measurement.depth ? 'value='+item.measurement.depth : '' %> >
                        <span class="input-group-addon" id="depth-addon">in.</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="inputHeight">Height:</label>
                    <div class="input-group">
                        <input type="text" name="measurement-height" class="form-control measurement-input"
                               aria-describedby="height-addon" id="inputHeight"
                        <%= item.measurement.height ? 'value='+item.measurement.height : '' %> >
                        <span class="input-group-addon" id="height-addon">in.</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="inputDiameter">Diameter:</label>
                    <div class="input-group">
                        <input type="text" name="measurement-diameter" class="form-control measurement-input"
                               aria-describedby="diameter-addon" id="inputDiameter"
                        <%= item.measurement.diameter ? 'value='+item.measurement.diameter : '' %> >
                        <span class="input-group-addon" id="diameter-addon">in.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/template" id="condition-template">
    <div class="col-md-12">
        <label>Condition <span class="subtext">(Select one)</span></label>
        <div class="radio">
            <% _.each(itemEnums.condition.description, function(cond){ %>
            <label class="radio-inline"><input name="condition-description" id="<%= cond %>"
                                               value="<%= item.condition.description %>" type="radio"
                    <%= item.condition.description === cond ? 'checked' : '' %> ><%= cond %></label>
            <% }); %>
        </div>
    </div>
</script>

<script type="text/template" id="button-template">
    <div class="col-md-12">
        <button type="button" class="btn btn-primary" onclick="parentView.save();" id="save">Save</button>
    </div>
</script>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.0/backbone-min.js"></script>
<script src="js/backbone-baseview.min.js"></script>

<script>
    var Enumerations = Backbone.Model.extend({
        urlRoot: '../enums.json',
        parse: function(response) {
            return response['itemEnums'];
        }
    });

    var Item = Backbone.Model.extend({
        urlRoot: '../item.json',
        parse: function(response) {
            return response['result']['item'];
        }
    });

    var TitleView = Backbone.BaseView.extend({
        template: _.template($('#title-template').html()),
        templateVars: function () {
            return this.model.toJSON();
        }
    });

    var DescriptionView = Backbone.BaseView.extend({
        template: _.template($('#description-template').html()),
        templateVars: function () {
            return this.model.toJSON();
        }
    });

    var NotesView = Backbone.BaseView.extend({
        template: template = _.template($('#notes-template').html()),
        templateVars: function () {
            return this.model.toJSON();
        }
    });

    var MaterialsView = Backbone.BaseView.extend({
        template: _.template($('#materials-template').html()),
        templateVars: function () {
            return {itemEnums: this.enumerationModel.toJSON(), item: this.itemModel.toJSON()};
        },
        initialize: function (options) {
            this.itemModel = options.itemModel;
            this.enumerationModel = options.enumerationModel;
        }
    });

    var MeasurementsView = Backbone.BaseView.extend({
        template: _.template($('#measurements-template').html()),
        templateVars: function () {
            return {itemEnums: this.enumerationModel.toJSON(), item: this.itemModel.toJSON()};
        },
        initialize: function (options) {
            this.itemModel = options.itemModel;
            this.enumerationModel = options.enumerationModel;
        },
        events: {
            'change input[type=radio]': 'changedRadio'
        },
        changedRadio: function () {
            this.$('.input-group-addon').text(this.$('input[name=measurement-unit]:checked').val()+'.');
            if(this.$('input[name=measurement-shape]:checked').val() === 'Circular'){
                this.$('.measurement-input').attr('disabled','');
                this.$('#inputDiameter').removeAttr('disabled');
            }
            if(this.$('input[name=measurement-shape]:checked').val() === 'Rectangular'){
                this.$('.measurement-input').removeAttr('disabled');
                this.$('#inputDiameter').attr('disabled','');
            }
        }
    });

    var ConditionView = Backbone.BaseView.extend({
        template: _.template($('#condition-template').html()),
        templateVars: function () {
            return {itemEnums: this.enumerationModel.toJSON(), item: this.itemModel.toJSON()};
        },
        initialize: function (options) {
            this.itemModel = options.itemModel;
            this.enumerationModel = options.enumerationModel;
        }
    });

    var ButtonView = Backbone.BaseView.extend({
        template: _.template($('#button-template').html())
    });

    var ParentView = Backbone.BaseView.extend({
        el: '#form',
        template: _.template($('#parent-template').html()),
        subViewConfig: {
            titleView: {
                construct: TitleView,
                location: '#title',
                singleton: true
            },
            descriptionView: {
                construct: DescriptionView,
                location: '#description',
                singleton: true
            },
            notesView: {
                construct: NotesView,
                location: '#notes',
                singleton: true
            },
            materialsView: {
                construct: MaterialsView,
                location: '#materials',
                singleton: true
            },
            measurementsView: {
                construct: MeasurementsView,
                location: '#measurements',
                singleton: true
            },
            conditionView: {
                construct: ConditionView,
                location: '#condition',
                singleton: true
            },
            buttonView: {
                construct: ButtonView,
                location: '#button',
                singleton: true
            }
        },
        initialize: function (options) {
            this.itemModel = options.itemModel;
            this.enumerationModel = options.enumerationModel;
            this.subs.add({
                'titleView': {model: this.itemModel},
                'descriptionView': {model: this.itemModel},
                'notesView': {model: this.itemModel},
                'materialsView': {
                    itemModel: this.itemModel,
                    enumerationModel: this.enumerationModel
                },
                'measurementsView' : {
                    itemModel: this.itemModel,
                    enumerationModel: this.enumerationModel
                },
                'conditionView' : {
                    itemModel: this.itemModel,
                    enumerationModel: this.enumerationModel
                },
                'buttonView' : {}
            });
        },
        save: function () {
            var shape = this.subs.get('measurementsView').$('input[name="measurement-shape"]:checked').val();
            this.itemModel.set({
                'id': this.subs.get('titleView').$('#id').val(),
                'title': this.subs.get('titleView').$('#inputTitle').val(),
                'description': this.subs.get('descriptionView').$('#inputDescription').val(),
                'dealerInternalNotes': this.subs.get('notesView').$('#inputNotes').val(),
                'material': {
                    'description': this.subs.get('materialsView').$('#selectMaterials').val(),
                    'restricted': this.subs.get('materialsView').$('input[name="material-restricted"]:checked').val() ? 'Y' : 'N'
                },
                'measurement': {
                    'unit': this.subs.get('measurementsView').$('input[name="measurement-unit"]:checked').val(),
                    'shape': shape
                },
                'condition': {
                    'description': this.subs.get('conditionView').$('input[name="condition-description"]:checked').val()
                }
            });
            if(shape === 'Rectangular') {
                this.itemModel.get('measurement').length = this.subs.get('measurementsView').$('#inputLength').val();
                this.itemModel.get('measurement').depth = this.subs.get('measurementsView').$('#inputDepth').val();
                this.itemModel.get('measurement').height = this.subs.get('measurementsView').$('#inputHeight').val();
                delete this.itemModel.get('measurement')['diameter'];
            }
            if(shape === 'Circular'){
                console.log('test');
                this.itemModel.get('measurement').diameter = this.subs.get('measurementsView').$('#inputDiameter').val();
                delete this.itemModel.get('measurement')['length'];
                delete this.itemModel.get('measurement')['depth'];
                delete this.itemModel.get('measurement')['height'];
            }
            console.log(this.itemModel.toJSON());
        }
    });

    var Router = Backbone.Router.extend({
        routes: {
            '' : 'home'
        }
    });

    var enumerationModel = new Enumerations();
    var itemModel = new Item();

    var parentView = new ParentView({itemModel: itemModel, enumerationModel: enumerationModel});

    var router = new Router();
    router.on('route:home', function () {
        $.when(itemModel.fetch(), enumerationModel.fetch()).done(function () {
            parentView.render();
        });
    });

    Backbone.history.start();
</script>

</body>
</html>