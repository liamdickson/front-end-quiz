<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/style.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>

<div class="container">
    <div id="form"></div>
</div>

<script type="text/template" id="parent-template">
    <form>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group" id="title">
                </div>
                <div class="form-group" id="description">
                </div>
                <div class="form-group" id="notes">
                </div>
                <div class="form-group" id="materials">
                </div>
            </div>
        </div>
        <div class="row top-buffer-lg" id="measurements">
        </div>
        <div class="row top-buffer-lg" id="condition">
        </div>
        <div class="row top-buffer-lg" id="button">
        </div>
    </form>
</script>

<script type="text/template" id="title-template">
    <input id="id" hidden="" value="<%= id ? id : '' %>">
    <label for="inputTitle">Title</label>
    <input name="title" type="text" id="inputTitle" class="form-control" required="" value="<%= title ? title : '' %>">
</script>

<script type="text/template" id="description-template">
    <label for="inputDescription">Description</label>
    <textarea name="description" id="inputDescription" class="form-control" required="" rows="10"
            ><%= description ? description : '' %></textarea>
</script>

<script type="text/template" id="notes-template">
    <label for="inputNotes">internal notes</label>
    <textarea name="dealerInternalNotes" id="inputNotes" class="form-control" required=""
            ><%= dealerInternalNotes ? dealerInternalNotes : '' %></textarea>
</script>

<script type="text/template" id="materials-template">
    <label for="selectMaterials">Materials</label>
    <select name="material-description" id="selectMaterials" class="form-control" required="">
        <option disabled="">Select...</option>
        <% _.each(itemEnums.material, function(mat){ %>
        <option <%= item.material.description === mat ? 'selected=""' : '' %> ><%= mat %></option>
        <% }); %>
    </select>
    <div class="checkbox">
        <label><input name="material-restricted" id="restrictedMaterial" type="checkbox"
            <%= (item.material.restricted === "Y") ? 'checked=""' : '' %> >
            <b>Check this box</b> if the listing contains or may contain restricted materials
        </label>
    </div>
</script>

<script type="text/template" id="measurements-template">
    <div class="form-group">
        <div class="col-md-12">
            <label>Measurements</label>
            <div class="radio" id="measurement-unit">
                Measurements are in:
                <% _.each(itemEnums.measurement.unit, function(unit, abbr){ %>
                <label class="radio-inline measurement-unit"><input id="<%= abbr %>" type="radio"
                                                                    value="<%= abbr %>" name="measurement-unit"
                    <%=item.measurement.unit === abbr ? 'checked' : '' %> >
                    <%= unit.charAt(0).toUpperCase() + unit.slice(1)  %> (<%= abbr %>)
                </label>
                <% }); %>
            </div>
            <div class="radio" id="measurement-shape">
                Measured item is:
                <% _.each(itemEnums.measurement.shape, function(shape){ %>
                <label class="radio-inline measurement-unit"><input id="<%= shape %>" type="radio"
                                                                    value="<%= shape %>" name="measurement-shape"
                    <%=item.measurement.shape === shape ? 'checked' : '' %> >
                    <%= shape  %>
                </label>
                <% }); %>
            </div>
            <div class="row top-buffer-md">
                <div class="col-md-3">
                    <label for="inputLength">Length:</label>
                    <div class="input-group">
                        <input type="text" name="measurement-length" class="form-control measurement-input"
                               aria-describedby="length-addon" id="inputLength"
                        <%= item.measurement.length ? 'value='+item.measurement.length : '' %> >
                        <span class="input-group-addon" id="length-addon">in.</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="inputDepth">Depth:</label>
                    <div class="input-group">
                        <input type="text" name="measurement-depth" class="form-control measurement-input"
                               aria-describedby="depth-addon" id="inputDepth"
                        <%= item.measurement.depth ? 'value='+item.measurement.depth : '' %> >
                        <span class="input-group-addon" id="depth-addon">in.</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="inputHeight">Height:</label>
                    <div class="input-group">
                        <input type="text" name="measurement-height" class="form-control measurement-input"
                               aria-describedby="height-addon" id="inputHeight"
                        <%= item.measurement.height ? 'value='+item.measurement.height : '' %> >
                        <span class="input-group-addon" id="height-addon">in.</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="inputDiameter">Diameter:</label>
                    <div class="input-group">
                        <input type="text" name="measurement-diameter" class="form-control measurement-input"
                               aria-describedby="diameter-addon" id="inputDiameter"
                        <%= item.measurement.diameter ? 'value='+item.measurement.diameter : '' %> >
                        <span class="input-group-addon" id="diameter-addon">in.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/template" id="condition-template">
    <div class="col-md-12">
        <label>Condition <span class="subtext">(Select one)</span></label>
        <div class="radio">
            <% _.each(itemEnums.condition.description, function(cond){ %>
            <label class="radio-inline"><input name="condition-description" id="<%= cond %>"
                                               value="<%= item.condition.description %>" type="radio"
                    <%= item.condition.description === cond ? 'checked' : '' %> ><%= cond %></label>
            <% }); %>
        </div>
    </div>
</script>

<script type="text/template" id="button-template">
    <div class="col-md-12">
        <button type="button" class="btn btn-primary" onclick="parentView.save();" id="save">Save</button>
    </div>
</script>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.0/backbone-min.js"></script>

<script>
    var Enumerations = Backbone.Model.extend({
        urlRoot: '../enums.json',
        parse: function(response) {
            return response['itemEnums'];
        }
    });

    var Item = Backbone.Model.extend({
        urlRoot: '../item.json',
        parse: function(response) {
            return response['result']['item'];
        }
    });

    var TitleView = Backbone.View.extend({
        el: '#title',
        render: function (item) {
            var template = _.template($('#title-template').html());
            this.$el.html(template(item.attributes));
        }
    });

    var DescriptionView = Backbone.View.extend({
        el: '#description',
        render: function (item) {
            var template = _.template($('#description-template').html());
            this.$el.html(template(item.attributes));
        }
    });

    var NotesView = Backbone.View.extend({
        el: '#notes',
        render: function (item) {
            var template = _.template($('#notes-template').html());
            this.$el.html(template(item.attributes));
        }
    });

    var MaterialsView = Backbone.View.extend({
        el: '#materials',
        render: function (item, enumeration) {
            var pObj = {itemEnums: enumeration.attributes, item: item.attributes};
            var template = _.template($('#materials-template').html());
            this.$el.html(template(pObj));
        }
    });

    var MeasurementsView = Backbone.View.extend({
        el: '#measurements',
        events: {
            'change input[type=radio]': 'changedRadio'
        },
        changedRadio: function () {
            this.$('.input-group-addon').text(this.$('input[name=measurement-unit]:checked').val()+'.');
            if(this.$('input[name=measurement-shape]:checked').val() === 'Circular'){
                this.$('.measurement-input').attr('disabled','');
                this.$('#inputDiameter').removeAttr('disabled');
            }
            if(this.$('input[name=measurement-shape]:checked').val() === 'Rectangular'){
                this.$('.measurement-input').removeAttr('disabled');
                this.$('#inputDiameter').attr('disabled','');
            }
        },
        render: function (item, enumeration) {
            var pObj = {itemEnums: enumeration.attributes, item: item.attributes};
            var template = _.template($('#measurements-template').html());
            this.$el.html(template(pObj));
        }
    });

    var ConditionView = Backbone.View.extend({
        el: '#condition',
        render: function (item, enumeration) {
            var pObj = {itemEnums: enumeration.attributes, item: item.attributes};
            var template = _.template($('#condition-template').html());
            this.$el.html(template(pObj));
        }
    });

    var ButtonView = Backbone.View.extend({
        el: '#button',
        render: function () {
            var template = _.template($('#button-template').html());
            this.$el.html(template);
        }
    });

    var ParentView = Backbone.View.extend({
        el: '#form',
        render: function(item, enumeration) {
            var template = _.template($('#parent-template').html());
            this.$el.html(template);

            this.titleView = new TitleView();
            this.descriptionView = new DescriptionView();
            this.notesView = new NotesView();
            this.matsView = new MaterialsView();
            this.measurementsView = new MeasurementsView();
            this.conditionView = new ConditionView();
            this.buttonView = new ButtonView();

            this.titleView.render(item);
            this.descriptionView.render(item);
            this.notesView.render(item);
            this.matsView.render(item, enumeration);
            this.measurementsView.render(item, enumeration);
            this.conditionView.render(item, enumeration);
            this.buttonView.render();
        },
        save: function () {
            item.set({
                'id': this.titleView.$('#id').val(),
                'title': this.titleView.$('#inputTitle').val(),
                'description': this.descriptionView.$('#inputDescription').val(),
                'dealerInternalNotes': this.notesView.$('#inputNotes').val(),
                'material': {
                    'description': this.matsView.$('#selectMaterials').val(),
                    'restricted': this.matsView.$('#restrictedMaterial').val() ? 'Y' : 'N'
                },
                'measurement': {
                    'unit': this.measurementsView.$('input[name="measurement-unit"]:checked').val(),
                    'shape': this.measurementsView.$('input[name="measurement-shape"]:checked').val(),
                    'length': this.measurementsView.$('#inputLength').val(),
                    'depth': this.measurementsView.$('#inputDepth').val(),
                    'height': this.measurementsView.$('#inputHeight').val(),
                    'diameter': this.measurementsView.$('#inputDiameter').val()
                },
                'condition': {
                    'description': this.conditionView.$('input[name="condition-description"]:checked').val()
                }
            });
            console.log(item.toJSON());
        }
    })

    var Router = Backbone.Router.extend({
        routes: {
            '' : 'home'
        }
    });

    var enumeration = new Enumerations();
    var item = new Item();

    var parentView = new ParentView();

    var router = new Router();
    router.on('route:home', function () {
        $.when(item.fetch(), enumeration.fetch()).done(function () {
            parentView.render(item, enumeration);
        });
    });

    Backbone.history.start();
</script>

</body>
</html>